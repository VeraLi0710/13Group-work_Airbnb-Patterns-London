---
title: 'Q7: Identifying Factors Associated with Airbnb Listings Exceeding 90 Days of Occupancy'
jupyter:
  jupytext:
    text_representation:
      extension: .qmd
      format_name: quarto
      format_version: '1.0'
      jupytext_version: 1.16.4
  kernelspec:
    display_name: Python (base)
    language: python
    name: base
---

## Section description


---

## Data and research methods
2023年12月release

---

```{python}
#| echo: false

# packages
import pandas as pd  
import numpy as np  
from scipy.stats import pearsonr, pointbiserialr, chi2_contingency  
import matplotlib.pyplot as plt  
from matplotlib.font_manager import FontProperties  
import seaborn as sns 
```

```{python}
#| echo: false

# 加载数据  
file_path = 'data/listings.csv'  
airbnb_data = pd.read_csv(file_path)  

# 查看数据基本信息  
print(airbnb_data.info()) 
```

```{python}
#| echo: false

# 数据清洗  
data = airbnb_data[['room_type', 'availability_365', 'calculated_host_listings_count', 'reviews_per_month', 'minimum_nights']].dropna()  
data = data[data['availability_365'] > 0]  # 只保留有出租天数的房源  

# 图 1-2: 分组直方图  
# 假设评论率为 50%，每次预订的评论率为 0.5  
data['estimated_nights_booked'] = data['reviews_per_month'] * 12 * data['minimum_nights'] * 2  

# 计算房源类型比例和平均预订天数  
summary_table = data.groupby('room_type').agg(  
    proportion=('room_type', 'count'),  
    avg_booking_days=('estimated_nights_booked', 'mean')  # 使用估算的预订天数  
)  
summary_table['proportion'] = (summary_table['proportion'] / summary_table['proportion'].sum() * 100).round(1)
# 创建图表  
fig = plt.figure(figsize=(12, 10))  # 调整整体图表大小  
gs = GridSpec(3, 1, figure=fig, height_ratios=[1.5, 1.2, 1.2])  # 调整子图比例  






# 定义分组区间和标签  
bins = [0, 30, 60, 90, 120, 150, 180, 210, 240, 255, float('inf')]  
labels = ['0', '1-30', '31-60', '61-90', '91-120', '121-150', '151-180', '181-210', '211-240', '241-255']  
data['booking_range'] = pd.cut(data['estimated_nights_booked'], bins=bins, labels=labels, right=False)  

# 统计每个区间的房源数量  
booking_distribution = data['booking_range'].value_counts().sort_index()  

# 分离大于 90 天的部分  
highlight_bins = ['91-120', '121-150', '151-180', '181-210', '211-240', '241-255']  
highlight_values = booking_distribution[highlight_bins]  
normal_bins = ['0', '1-30', '31-60', '61-90']  
normal_values = booking_distribution[normal_bins]  

# 使用 Pastel1 调色盘  
pastel_palette = sns.color_palette("Pastel1")  
normal_color = pastel_palette[1]  # 柔和的蓝色  
highlight_color = pastel_palette[0]  # 柔和的红色  

# 绘制直方图  
ax2 = fig.add_subplot(gs[1, 0])  

# 绘制正常部分  
sns.barplot(  
    x=normal_bins,  
    y=normal_values,  
    color=normal_color,  
    edgecolor='black',  
    ax=ax2,  
    label='<= 90 days'  
)  

# 绘制高亮部分  
sns.barplot(  
    x=highlight_bins,  
    y=highlight_values,  
    color=highlight_color,  
    edgecolor='black',  
    ax=ax2,  
    label='> 90 days'  
)  

# 添加标题和标签  
ax2.set_title('1-2: Distribution of Estimated Booking Days', fontsize=14, pad=10)  
ax2.set_xlabel('Occupancy (last 12 months)', fontsize=12)  
ax2.set_ylabel('Listings', fontsize=12)  
ax2.set_xticklabels(labels, rotation=45)  

# 添加图例  
ax2.legend(title='Booking Days', fontsize=10)  

# 对 estimated_nights_booked 进行对数变换（加 1 防止 log(0)）  
data['log_estimated_nights_booked'] = np.log1p(data['estimated_nights_booked'])  
```

